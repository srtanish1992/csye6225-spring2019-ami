{
    "variables": {
        "aws_access_key": "",
        "aws_secret_key": "",
        "aws_region": "",
        "subnet_id": "",
        "source_ami": "ami-9887c6e7",
        "ssh_username": "centos"
    },
    "builders": [{
        "type": "amazon-ebs",
        "access_key": "{{user `aws_access_key`}}",
        "secret_key": "{{user `aws_secret_key`}}",
        "region": "{{user `aws_region`}}",
        "instance_type": "t2.micro",
        "subnet_id": "{{user `subnet_id`}}",
        "source_ami": "{{user `source_ami`}}",
        "ssh_username": "{{user `ssh_username`}}",
        "ami_name": "csye6225_{{timestamp}}",
        "ami_description": "CentOS AMI for CSYE 6225 - Spring 2019",
        "launch_block_device_mappings": [{
            "device_name": "/dev/sda1",
            "volume_size": 20,
            "volume_type": "gp2",
            "delete_on_termination": true
        }],

        "tags": {
            "Name": "csye6225"
        }

    }],
    "provisioners": [
        {
            "type": "shell",
            "inline": [
                "sudo su",
                "sudo yum install ruby ntp wget java-1.8.0-openjdk-devel -y",
                "cd /home/centos/",
                "sudo yum install vim -y",
                "sudo yum install mysql -y",
                "sudo groupadd tomcat",
                "sudo useradd -M -s /bin/nologin -g tomcat -d /opt/tomcat tomcat",
                "echo Installing Authbind",
                "cd /home/centos",
                "sudo rpm -Uvh https://s3.amazonaws.com/aaronsilber/public/authbind-2.1.1-0.1.x86_64.rpm",
                "sudo touch /etc/authbind/byport/80",
                "sudo chmod 500 /etc/authbind/byport/80",
                "sudo chown tomcat /etc/authbind/byport/80",
                "sudo touch /etc/authbind/byport/443",
                "sudo chmod 500 /etc/authbind/byport/443",
                "sudo chown tomcat /etc/authbind/byport/443",
                "cd /tmp",
                "wget ftp://apache.cs.utah.edu/apache.org/tomcat/tomcat-8/v8.5.39/bin/apache-tomcat-8.5.39.tar.gz",
                "sudo mkdir /opt/tomcat",
                "sudo tar xvf apache-tomcat-8*tar.gz -C /opt/tomcat --strip-components=1",
                "cd /opt/tomcat",
                "sudo chgrp -R tomcat /opt/tomcat",
                "sudo chmod -R g+r conf",
                "sudo chmod g+x conf",
                "sudo chown -R tomcat webapps/ work/ temp/ logs/",
                "cd /usr/lib/systemd/system",
                "sudo touch tomcat.service",
                "sudo chmod 777 tomcat.service",
                "echo '[Unit]' > tomcat.service",
                "echo 'Description=Apache Tomcat Web Application Container' >> tomcat.service",
                "echo 'After=syslog.target network.target' >> tomcat.service",
                "echo '[Service]' >> tomcat.service",
                "echo 'Type=forking' >> tomcat.service",
                "echo 'Environment=JAVA_HOME=/usr/lib/jvm/jre' >> tomcat.service",
                "echo 'Environment=CATALINA_PID=/opt/tomcat/temp/tomcat.pid' >> tomcat.service",
                "echo 'Environment=CATALINA_HOME=/opt/tomcat' >> tomcat.service",
                "echo 'Environment=CATALINA_BASE=/opt/tomcat' >> tomcat.service",
                "echo 'Environment=\"CATALINA_OPTS=-Xms512M -Xmx1024M -server -XX:+UseParallelGC\"' >> tomcat.service",
                "echo 'Environment=\"JAVA_OPTS=-Djava.awt.headless=true -Djava.security.egd=file:/dev/./urandom\"' >> tomcat.service",
                "echo 'ExecStart=/opt/tomcat/bin/startup.sh' >> tomcat.service",
                "echo 'ExecStop=/bin/kill -15 $MAINPID' >> tomcat.service",
                "echo 'User=tomcat' >> tomcat.service",
                "echo 'Group=tomcat' >> tomcat.service",
                "echo 'UMask=0007' >> tomcat.service",
                "echo 'RestartSec=10' >> tomcat.service",
                "echo 'Restart=always' >> tomcat.service",
                "echo '[Install]' >> tomcat.service",
                "echo 'WantedBy=multi-user.target' >> tomcat.service",
                "sudo systemctl daemon-reload",
                "sudo systemctl enable tomcat",
                "sudo systemctl start tomcat",
                "cd /home/centos",
                "wget https://aws-codedeploy-us-east-1.s3.amazonaws.com/latest/install",
                "chmod +x ./install",
                "sudo ./install auto",
                "rm install",
                "sudo service codedeploy-agent stop",
                "sudo service codedeploy-agent start",
                "sudo sed -i 's:Connector port=\"8080\":Connector port=\"80\":g' /opt/tomcat/conf/server.xml",
                "sudo sed -i 's:ExecStart=/opt/tomcat/bin/startup.sh:ExecStart=/usr/bin/authbind -deep /opt/tomcat/bin/startup.sh:g' /usr/lib/systemd/system/tomcat.service",
                "sudo systemctl daemon-reload",
                "sudo systemctl restart tomcat",
                "sudo mkdir /tmp/AmazonCloudWatchAgent",
                "cd /tmp/AmazonCloudWatchAgent/",
                "sudo wget https://s3.amazonaws.com/amazoncloudwatch-agent/centos/amd64/latest/amazon-cloudwatch-agent.rpm",
                "sudo rpm -U ./amazon-cloudwatch-agent.rpm",
                "cd /home/centos",
                "sudo echo '[Unit]' > cloudwatch.service",
                "echo 'Description=Service for Cloudwatch logs Agent' >> cloudwatch.service",
                "echo 'After=c-local.service' >> cloudwatch.service",
                "echo '[Service]' >> cloudwatch.service",
                "echo 'Type=simple' >> cloudwatch.service",
                "echo 'Restart=always' >> cloudwatch.service",
                "echo 'KillMode=process' >> cloudwatch.service",
                "echo 'TimeoutSec=infinity' >> cloudwatch.service",
                "echo 'Type=simple' >> cloudwatch.service",
                "echo 'PIDFile=/opt/aws/amazon-cloudwatch-agent/var/amazon-cloudwatch-agent.pid' >> cloudwatch.service",
                "echo 'ExecStart=/opt/aws/amazon-cloudwatch-agent/bin/awslogs-agent-launcher.sh --start --background --pidfile $PIDFILE --user awslogs --chuid awslogs &amp;' >> cloudwatch.service",
                "echo '[Install]' >> cloudwatch.service",
                "echo 'WantedBy=multi-user.target' >> cloudwatch.service",
                "sudo mv cloudwatch.service /etc/systemd/system",
                "cd /etc/systemd/system",
                "sudo systemctl start cloudwatch.service",
                "sudo systemctl enable cloudwatch.service"
            ]
        }

    ]

}
